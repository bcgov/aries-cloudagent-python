version: "3"
services:
  cloud-agent:
    image: bcgovimages/aries-cloudagent:py36-1.16-0_0.6.0
    ports:
      - "${AGENT_PORT}:${AGENT_PORT}"
      - "${ADMIN_PORT}:${ADMIN_PORT}"
    entrypoint: /bin/bash
    command: [
        "-c",
        "curl -d '{\"seed\":\"${INDY_SEED}\", \"role\":\"TRUST_ANCHOR\", \"alias\":\"${AGENT_LABEL}\"}' -X POST ${LEDGER_URL}/register; \
        sleep 5; \
        aca-py start \
        -it http '0.0.0.0' ${AGENT_PORT} \
        -ot http \
        --admin '0.0.0.0' ${ADMIN_PORT} \
        -e 'http://localhost:${AGENT_PORT}/' \
        --auto-provision \
        --wallet-storage-type postgres_storage \
        --wallet-storage-config '{\"url\":\"host.docker.internal:5432\", \"wallet_scheme\":\"MultiWalletSingleTableSharedPool\"}' \
        --wallet-storage-creds '{\"account\":\"${POSTGRES_ACCOUNT}\",\"password\":\"${POSTGRES_ACCOUNT_PASSWORD}\",\"admin_account\":\"${POSTGRES_ADMIN}\",\"admin_password\":\"${POSTGRES_ADMIN_PASSWORD}\"}' \
        --wallet-type indy \
        --wallet-name ${MAIN_WALLET_NAME} \
        --wallet-key ${WALLETKEY} \
        --seed ${INDY_SEED} \
        --genesis-url ${LEDGER_URL}/genesis \
        --label '${AGENT_LABEL}' \
        --admin-insecure-mode \
        --multitenant \
        --multitenant-admin \
        --jwt-secret very_secret_secret \
        --log-level debug",
      ]
